setproperty ABORT_ON_USER_ERROR TRUE
delete filtre
create filtre filtre.c include/SIMD.c

activate MUST_REGIONS
activate PRECONDITIONS_INTER_FULL
activate TRANSFORMERS_INTER_FULL

setproperty RICEDG_STATISTICS_ALL_ARRAYS TRUE
activate RICE_SEMANTICS_DEPENDENCE_GRAPH

setproperty SIMD_FORTRAN_MEM_ORGANISATION=FALSE
setproperty SAC_SIMD_REGISTER_WIDTH = 128
setproperty SIMD_AUTO_UNROLL_SIMPLE_CALCULATION FALSE
setproperty SIMD_AUTO_UNROLL_MINIMIZE_UNROLL FALSE
setproperty PRETTYPRINT_ALL_DECLARATIONS TRUE


echo
echo Initial code
echo

module filtre
display PRINTED_FILE

apply SIMD_ATOMIZER
display PRINTED_FILE
apply SIMDIZER_AUTO_UNROLL
apply CUMULATED_REDUCTIONS
apply SIMD_REMOVE_REDUCTIONS
display PRINTED_FILE


#apply FULL_UNROLL
#loop
display PRINTED_FILE
apply SINGLE_ASSIGNMENT


apply PARTIAL_EVAL
apply SUPPRESS_DEAD_CODE
display PRINTED_FILE


#apply DEATOMIZER
#apply PARTIAL_EVAL
#apply USE_DEF_ELIMINATION
#display PRINTED_FILE


display PRINTED_FILE

apply SIMDIZER

display PRINTED_FILE

#apply USE_DEF_ELIMINATION
#display PRINTED_FILE

apply SIMD_LOOP_CONST_ELIM
#apply INVARIANT_CODE_MOTION
#apply PARTIAL_REDUNDANCY_ELIMINATION
display PRINTED_FILE

#apply USE_DEF_ELIMINATION
apply CLEAN_DECLARATIONS
display PRINTED_FILE
#setproperty EOLE_OPTIMIZATION_STRATEGY "CSE"
#apply OPTIMIZE_EXPRESSIONS
#apply CLEAN_DECLARATIONS
#
#setproperty EOLE_OPTIMIZATION_STRATEGY "ICM"
#apply OPTIMIZE_EXPRESSIONS
#apply PARTIAL_EVAL
#display PRINTED_FILE


echo
echo simdized code
echo

display PRINTED_FILE
apply UNSPLIT

shell cc filtre.c include/SIMD.c -o filtre0
shell sed -i -e '1 i #include "SIMD.h"' filtre.database/Src/filtre.c
shell cc -Iinclude filtre.database/Src/filtre.c include/SIMD.c -o filtre1
shell sed -i -e '1 d' filtre.database/Src/filtre.c
shell if test "`./filtre0`" = "`./filtre1`" ; then echo seq-ok ; else echo seq-ko ; fi

#shell ./compileC.sh filtre filtre.c filtre-sse.c
#shell cc -O3 -I. -march=native filtre-sse.c -o filtre2
#shell if test "`./filtre0`" = "`./filtre2`" ; then echo sse-ok ; else echo sse-ko ; fi
#shell rm -f filtre[012] filtre-sse.c

close
delete filtre
quit
