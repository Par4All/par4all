#!/bin/sh
#
# $Id$
#
# Usage: logfile_to_tpips <workspacename>
#
#	Convert the logfile of the named workspace
#	created by wpips to a tpips source.
#
# Known limitations:
#
#	- does not display all the resources for a
#	  rule creating multiple resources.
#

sed=${PIPS_SED:-sed}

WS=${1:?"Please give me the workspace name to work with"}

if [ -z "`basename $WS`" ]
then
	echo $0 remove trailing slash in "$WS"
	exit 1
fi

if [ `basename $WS` != "$WS" ]
then
	echo $0 can only be used on a local database
	exit 1
fi

if [ `basename $WS .database` != "$WS" ]
then
    WS=`basename $WS .database`
fi

WDIR=${WS}.database
CAT=${PAGER:-cat}

if [ ! -r $WDIR/Logfile ]
then
    echo $0: Cannot open: $WDIR/Logfile
    exit 1
fi

echo \#
echo \# file generated by logfile_to_tpips for workspace $WS
echo \#
$sed -n \
    "/^echo/p;
     /^shell/p;
     /^cd/p;
     /^set/p;
     s,${PIPS_ROOT},\\\${PIPS_ROOT},g;
     s,^Registering file \(.*\),create $WS \1,p;
     s,^Module \(.*\) selected,module \1,p;
     s,^Closing all modules.,close,p;
     s,^Workspace [^ ]* opened,open $WS,p;
     s,^Directory \(.*\) selected,cd \1,p;
     s,^Request: build resource \(.*\) for module \(.*\).,display \1[\2],p;
     s,^Request: perform rule \(.*\) on module \(.*\).,apply \1[\2],p;
     s,^Options: phase \(.*\) (\(.*\)) set on.,activate \2 # \1,p;
     s,^Selecting rule: \(.*\),activate \1,p;
     s,^HPFC View of \"\(.*\)\" done.,shell $CAT $WDIR\/hpfc\/\1,p;
     s,^User Request...,# user request :,p;
     s,^\"\(.*\)\"\$,\1,p" $WS.database/Logfile |
{ tr '\012' '' ; echo ; } | 
$sed "s,create $WS,,g;s,,,g;s,\$,,;" | 
tr '' '\012'
echo quit
echo \# EOF
#end
