#! /bin/sh
#
# $RCSfile: pips_at_night,v $ version $Revision$
# ($Date: 1996/07/19 10:51:34 $, )
# (c) Fabien COELHO July 1996
# 
# what to do at night...
#

# source environment if needed (as from cron)
test -r $HOME/.profile && . $HOME/.profile
test "$PIPS_DIR" || . /projects/Pips/pipsrc.sh

unset no_cleaning no_newgen no_linear no_pips no_validation

if test -x /usr/openwin/bin/mail
then 
  mail=/usr/openwin/bin/mail
else
  mail=mail
fi

arch=.
user=`whoami`
email=${REPLYTO:-$user}
script=`basename $0`
verbose=:

verb()
{
    echo "$script: $@" >&2
}

usage()
{
    ret=$1
    shift
    cat <<-EOF
	$script (version $Revision$) - $@
	  -h: this help
	  -v: verbose
	  -c arch: compile for arch (may be a list, default is .)
	  -a email: address to report (default: \$REPLYTO else \`whoami\`)
	  -C: skip cleaning
	  -N: skip newgen
	  -L: skip linear
	  -P: skip pips
	  -V: skip validation
EOF
    exit $ret
}

# compile what[nlp] name[...] report[filename] arch...
# only stderr is sent in the mail
compile()
{
    what=$1; name=$2; report=$3; shift 3
    {
      make-pips -$what -o $report clean
      for a in "$@"; do
	make-pips -$what -o $report -m $a ARCH=$a clean-compiled recompile
      done 
    } 2>&1 > /dev/null | 
	$mail -s "$script: $name recompile night report" $email
}

while getopts hvCNLPVc:a: OPT
do
    case $OPT in
	h) usage 0 "some help" ;;
	a) email=$OPTARG ;;
	c) arch="$OPTARG" ;;
	v) verbose=verb ;;
	C) no_cleaning=1 ;;
	N) no_newgen=1 ;;
	L) no_linear=1 ;;
	P) no_pips=1 ;;
	V) no_validation=1 ;;
	*) usage 2 "invalid option" ;;
    esac
done

report=/tmp/${script}.${user}.$$
rm -f ${report}*

#
# do the job

{
$verbose starting $script for $email 
$verbose date: `date`

test "$no_cleaning" ||
{
  $verbose deleting old workspaces...
  $verbose date: `date`
  find ${PIPS_HOME}/Pips -name '*.database' -type d -mtime +7 -print | 
    xargs ${PIPS_UTILDIR}/Delete

  $verbose removing core files older than one week
  find ${PIPS_HOME}/Pips -name core -mtime +7 -print | 
    xargs rm -f
}

test "$no_newgen" ||
{
  $verbose recompiling NEWGEN - Production
  $verbose date: `date`
  compile n newgen $report $arch
}

test "$no_linear" ||
{
  $verbose recompiling LINEAR - Production
  $verbose date: `date`
  compile l linear $report $arch
}

test "$no_pips" ||
{
  $verbose recompiling PIPS - Production
  $verbose date: `date`
  compile p pips $report $arch
}

# summary
test "$no_newgen$no_linear$no_pips" -eq 111 ||
{
  grep 'failed$' $report > $report.failed
  if test -z $report.failed ; then summary=SUCCEEDED; else summary=FAILED; fi
  $mail -s "$script: recompile $summary" $email < $report.failed
  rm -f $report*
}

# Validate Pips
test "$no_validation" || 
{
  $verbose Validating PIPS
  $verbose date: `date` 
  Validate -vti 50 -a ${email}
}

$verbose date: `date`
$verbose end of  $script for $email 
} 2>&1 | $mail -s "$script: night report" ${email}
